#!/bin/bash

# Add all packages' /bin & /sbin into $PATH
for package_bin_dir in $(ls -d /var/vcap/packages/*/*bin)
do
  export PATH=${package_bin_dir}:$PATH
done

export SHIELD_API=http://localhost:<%= p("shield.daemon.port") %>

<% if_p("shield.schedule.name") do |schedule| %>
SCHEDULE=$(shield --raw show schedule <%= schedule %> | jq -r '.uuid // empty')
if [[ -z ${SCHEDULE} ]]; then
  echo "Creating schedule"
  cat /var/vcap/jobs/shield-daemon/config/schedule.json | shield --raw create schedule
else
  echo "Editing schedule"
  cat /var/vcap/jobs/shield-daemon/config/schedule.json | shield --raw edit schedule
fi
<% end %>

<% if_p("shield.retention.name") do |retention| %>
RETENTION=$(shield --raw show retention policy <%= retention %> | jq -r '.uuid // empty')
if [[ -z ${RETENTION} ]]; then
  echo "Creating retention"
	cat /var/vcap/jobs/shield-daemon/config/retention.json | shield --raw create retention policy
else
  echo "Editing retention"
  cat /var/vcap/jobs/shield-daemon/config/retention.json | shield --raw edit retention policy
fi
<% end %>

<% if_p("shield.store.name") do |store| %>
STORE=$(shield --raw show store <%= store %> | jq -r '.uuid // empty')
if [[ -z ${STORE} ]]; then
  echo "Creating store"
	cat /var/vcap/jobs/shield-daemon/config/store.json | shield --raw create store
else
  echo "Editing store"
	cat /var/vcap/jobs/shield-daemon/config/store.json | shield --raw edit store
fi
<% end %>
