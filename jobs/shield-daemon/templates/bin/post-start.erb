#!/bin/bash

# Add all packages' /bin & /sbin into $PATH
for package_bin_dir in $(ls -d /var/vcap/packages/*/*bin)
do
  export PATH=${package_bin_dir}:$PATH
done

export SHIELD_API=http://localhost:<%= p("shield.daemon.port") %>

<% if !properties.shield.schedule.name.nil? %>
SCHEDULE=$(shield --raw show schedule <%= p("shield.schedule.name") %> | jq -r '.uuid // empty')
if [[ -z ${SCHEDULE} ]]; then
  echo "Creating schedule"
  cat /var/vcap/jobs/shield-daemon/config/schedule.json | shield --raw create schedule
else
  echo "Editing schedule"
  cat /var/vcap/jobs/shield-daemon/config/schedule.json | shield --raw edit schedule
fi
<% end %>

<% if !properties.shield.retention.name.nil? %>
RETENTION=$(shield --raw show retention policy <%= p("shield.retention.name") %> | jq -r '.uuid // empty')
if [[ -z ${RETENTION} ]]; then
  echo "Creating retention"
	cat /var/vcap/jobs/shield-daemon/config/retention.json | shield --raw create retention policy
else
  echo "Editing retention"
  cat /var/vcap/jobs/shield-daemon/config/retention.json | shield --raw edit retention policy
fi
<% end %>

<% if !properties.shield.store.name.nil? %>
STORE=$(shield --raw show store <%= p("shield.store.name") %> | jq -r '.uuid // empty')
if [[ -z ${STORE} ]]; then
  echo "Creating store"
	cat /var/vcap/jobs/shield-daemon/config/store.json | shield --raw create store
else
  echo "Editing store"
	cat /var/vcap/jobs/shield-daemon/config/store.json | shield --raw edit store
fi
<% end %>