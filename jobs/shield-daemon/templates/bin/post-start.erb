#!/bin/bash

# Add all packages' /bin & /sbin into $PATH
for package_bin_dir in $(ls -d /var/vcap/packages/*/*bin)
do
  export PATH=${package_bin_dir}:$PATH
done

export TMPDIR=${TMPDIR:="/tmp"}

<%# Create a specific  config file for shield-daemon stuff, to avoid race conditions
    in case we are colocated with shield-agent. %>
shield -c $TMPDIR/.shield_daemon_config create backend default https://<%= p("shield.daemon.domain") %>:<%= p("shield.daemon.port") %>

<%#
  The SHIELD_API_TOKEN is set here so that the post-start script will fail to render
  when provisioning_key is not specified, but the script is about to try to create schedules
%>
export SHIELD_API_TOKEN=<%= p("shield.provisioning_key") %>

<% if p("shield.skip_ssl_verify") %>
export SHIELD_SKIP_SSL_VERIFY=true
<% end %>

<%  schedules = p("shield.schedules", {}) %>
<% if_p("shield.schedule.name", "shield.schedule.when")  do |name, wenn|
  schedules[name]= wenn
end %>

<% if schedules.any? %>
    <% schedules.each do |name, value| %>
cat <<EOF > $TMPDIR/schedule-<%= name %>.json
{
 "name":    "<%= name %>",
 "when":    "<%= value %>"
}
EOF

SCHEDULE=$(shield -c $TMPDIR/.shield_daemon_config --raw show schedule <%= name %> | jq -r '.uuid // empty')
if [[ -z ${SCHEDULE} ]]; then
  echo "Creating schedule"
  cat $TMPDIR/schedule-<%= name %>.json | shield -c $TMPDIR/.shield_daemon_config --raw create schedule
else
  echo "Editing schedule"
  cat $TMPDIR/schedule-<%= name %>.json | shield -c $TMPDIR/.shield_daemon_config --raw edit schedule "<%= name %>"
fi

    # End of schedule
    <% end %>

# End of schedules
<% end %>

<%  retentions = p("shield.retentions", {}) %>
<% if_p("shield.retention.name", "shield.retention.expires")  do |name, expires|
    retentions[name] = expires
end %>

<% if retentions.any? %>
    <% retentions.each do |name, value| %>
cat <<EOF > $TMPDIR/retention-<%= name %>.json
{
 "name":    "<%= name %>",
 "expires":  <%= value %>
}
EOF

RETENTION=$(shield -c $TMPDIR/.shield_daemon_config --raw show retention policy <%= name %> | jq -r '.uuid // empty')
if [[ -z ${RETENTION} ]]; then
  echo "Creating retention"
  cat $TMPDIR/retention-<%= name %>.json | shield -c $TMPDIR/.shield_daemon_config --raw create retention policy
else
  echo "Editing retention"
  cat $TMPDIR/retention-<%= name %>.json | shield -c $TMPDIR/.shield_daemon_config --raw edit retention policy "<%= name %>"
fi
    <% end %>
<% end %>

<%  stores = p("shield.stores", {}) %>
<% if_p("shield.store.name", "shield.store.plugin", "shield.store.config")  do |name, plugin, config|
    stores[name] = {"plugin" => plugin, "config" => config}
end %>

<% if stores.any? %>
<%
  require 'json'
%>

    <% stores.each do |name, store| %>
<%
  require 'json'
%>
cat <<EOF > $TMPDIR/store-<%= name %>.json
{
  "name":     "<%= name %>",
  "plugin":   "<%= store["plugin"] %>",
  "endpoint": <%= store["config"].to_json.dump %>
}
EOF

STORE=$(shield -c $TMPDIR/.shield_daemon_config --raw show store <%= name %> | jq -r '.uuid // empty')
if [[ -z ${STORE} ]]; then
  echo "Creating store"
	cat $TMPDIR/store-<%= name %>.json | shield -c $TMPDIR/.shield_daemon_config --raw create store
else
  echo "Editing store"
	cat $TMPDIR/store-<%= name %>.json | shield -c $TMPDIR/.shield_daemon_config --raw edit store <%= name %>
fi
    <% end %>
<% end %>
