#!/bin/bash
set -eu
LOG_DIR=/var/vcap/sys/log/shield
JOB_DIR=/var/vcap/jobs/shield-agent
TMP_DIR=(mktemp --tmpdir import.XXXXXX)
cp -f $LOG_DIR/import.yml $LOG_DIR/last-import.yml

trap "rm -rf ${TMP_DIR}" INT TERM QUIT EXIT
sed -e '
  s/(deployment)/<%= spec.deployment %>/g;
  s/(index)/<%= spec.index.to_s %>/g;
  s/(ip)/<%= spec.ip %>/g;
  s/(name)/<%= spec.name %>/g;
  s/(az)/<%= spec.az %>/g;
' $JOB_DIR/config/import.yml |\
  /var/vcap/packages/shield/bin/buckler \
    --config ${TMP_DIR}/.shield \
      import - >$LOG_DIR/import.yml 2>&1
exit 0
